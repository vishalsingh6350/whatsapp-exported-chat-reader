import React, { useContext, useState } from "react";
import { stateContext } from "../App.js";
import Messages from "./Messages.js";
const UploadFile = () => {
  const [messagesReadingDoneFlag, setmessagesReadingDoneFlag] = useState(false);
  const {
    chatDetails,
    setchatDetails,
    originalChatDetailsRefernce,
    setcurrentPage,
    setuser,
    user,
  } = useContext(stateContext);
  const handleFileInput = (e) => {
    // console.log(e);
    const reader = new FileReader();
    reader.onload = () => {
      if (reader.readyState === 2) {
        const str = reader.result;
        const arrayString = str.split("\n");
        let messages = [];
        // let prevDate = "";
        let sender = new Set();
        arrayString.forEach((item) => {
          if (
            item.split("-").length > 1 &&
            item
              .split("-")[0]
              .trim()
              .match(
                /([0-9][0-9]*\/[0-9][0-9]*\/[0-9][0-9]*,.[0-9][0-9]*:[0-9][0-9]*)/g
              )
          ) {
            // console.log(item);
            if (item.split("-").slice(1).join("-").split(":").length > 1) {
              messages.push({
                key: messages.length,
                message: `${item
                  .split("-")
                  .slice(1)
                  .join("-")
                  .split(":")
                  .slice(1)
                  .join(":")}`,
                time: String(item.split("-", 1)),
                sender: String(
                  item.split("-").slice(1).join("-").split(":", 1)
                ),
              });
              sender = sender.add(
                String(item.split("-").slice(1).join("-").split(":", 1))
              );
            } else {
              // console.log(item);
              messages.push({
                message: `${item.split("-").slice(1).join("-")}`,
                time: String(item.split("-", 1)),
                sender: "none",
              });
            }
          } else {
            if (messages[messages.length - 1]) {
              messages[messages.length - 1].message += `\n${item}`;
            }
          }
        });
        sender = [...sender].sort((a, b) => {
          if (a.match(/[a-zA-Z].*[0-9]*/) && b.match(/[a-zA-Z].*[0-9]*/)) {
            // console.log(b - a);
            return a.localeCompare(b);
          } else if (a.match(/[a-zA-Z].*[0-9]*/)) {
            return -1;
          } else {
            return 1;
          }
        });
        // console.log(sender);
        // console.log(
        //   e.target.files[0].name.substr(0, e.target.files[0].name.length - 4)
        // );
        setchatDetails({
          messages,
          sender,
          chatName: e.target.files[0].name.substr(
            0,
            e.target.files[0].name.length - 4
          ),
        });
        originalChatDetailsRefernce.current = {
          messages,
          sender,
          chatName: e.target.files[0].name.substr(
            0,
            e.target.files[0].name.length - 4
          ),
        };
        // setcurrentPage("Messages");
        // messages.forEach((item) => console.log(item.message));
      }
    };
    reader.readAsText(e.target.files[0]);
  };
  return (
    <div className="uploadFilePage">
      <>
        <div className="heroText">
          Select your whatsapp chat exported file....
        </div>
        <label htmlFor="uploadfile" className="uploadLabel">
          <svg
            width="216"
            height="194"
            viewBox="0 0 216 194"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M110.62 0.422811L103.592 2.23658L17.0026 24.5826L9.97437 26.3963C6.56294 27.2808 3.6414 29.4834 1.85071 32.5208C0.0600135 35.5582 -0.453589 39.1825 0.422575 42.5984L30.8987 160.864C31.7825 164.278 33.9835 167.202 37.0187 168.994C40.0539 170.786 43.6754 171.3 47.0888 170.423L47.107 170.418L147.717 144.454L147.735 144.449C151.146 143.565 154.068 141.362 155.859 138.325C157.649 135.287 158.163 131.663 157.287 128.247L126.811 9.98163C125.927 6.5677 123.726 3.64402 120.691 1.85201C117.655 0.0600029 114.034 -0.453986 110.62 0.422811Z"
              fill="#F2F2F2"
            />
            <path
              d="M111.576 4.1309L103.252 6.27918L19.2543 27.9562L10.9299 30.1045C8.50057 30.7343 6.42006 32.3028 5.14486 34.4658C3.86965 36.6288 3.5039 39.2097 4.12784 41.6423L34.6039 159.908C35.2333 162.339 36.8007 164.421 38.9621 165.697C41.1236 166.973 43.7026 167.339 46.1333 166.715L46.1515 166.71L146.761 140.746L146.78 140.741C149.209 140.111 151.289 138.543 152.565 136.38C153.84 134.217 154.205 131.636 153.581 129.204L123.105 10.938C122.476 8.50685 120.909 6.42484 118.747 5.14871C116.586 3.87258 114.007 3.50654 111.576 4.1309V4.1309Z"
              fill="white"
            />
            <path
              d="M105.29 42.4284L54.3944 55.563C53.8259 55.7097 53.2225 55.6244 52.7169 55.3259C52.2113 55.0274 51.8449 54.5401 51.6983 53.9712C51.5517 53.4024 51.6369 52.7985 51.9352 52.2925C52.2335 51.7866 52.7205 51.4199 53.2889 51.2732L104.185 38.1385C104.753 37.9924 105.356 38.0781 105.861 38.3766C106.367 38.6752 106.733 39.1623 106.879 39.7308C107.026 40.2994 106.941 40.9029 106.643 41.4087C106.345 41.9145 105.858 42.2813 105.29 42.4284V42.4284Z"
              fill="#F2F2F2"
            />
            <path
              d="M115.997 47.3858L56.2599 62.8021C55.6914 62.9488 55.088 62.8635 54.5824 62.565C54.0768 62.2665 53.7104 61.7792 53.5638 61.2103C53.4172 60.6415 53.5024 60.0376 53.8007 59.5316C54.099 59.0256 54.586 58.659 55.1544 58.5123L114.892 43.0959C115.46 42.9492 116.064 43.0345 116.569 43.333C117.075 43.6316 117.441 44.1189 117.588 44.6877C117.735 45.2566 117.649 45.8605 117.351 46.3664C117.053 46.8724 116.566 47.2391 115.997 47.3858V47.3858Z"
              fill="#F2F2F2"
            />
            <path
              d="M113.651 74.8705L62.7545 88.0052C62.473 88.0778 62.18 88.0943 61.8922 88.0536C61.6044 88.0129 61.3274 87.9159 61.077 87.7681C60.8267 87.6203 60.6079 87.4245 60.4331 87.1921C60.2583 86.9597 60.131 86.6951 60.0584 86.4134C59.9858 86.1317 59.9694 85.8385 60.01 85.5505C60.0507 85.2624 60.1476 84.9852 60.2953 84.7347C60.443 84.4841 60.6386 84.2652 60.8709 84.0903C61.1032 83.9154 61.3676 83.788 61.649 83.7153L112.545 70.5807C112.827 70.508 113.12 70.4916 113.407 70.5323C113.695 70.573 113.972 70.67 114.223 70.8178C114.473 70.9656 114.692 71.1613 114.867 71.3937C115.041 71.6262 115.169 71.8908 115.241 72.1725C115.314 72.4541 115.33 72.7474 115.29 73.0354C115.249 73.3234 115.152 73.6006 115.004 73.8512C114.857 74.1017 114.661 74.3207 114.429 74.4956C114.196 74.6705 113.932 74.7979 113.651 74.8705V74.8705Z"
              fill="#F2F2F2"
            />
            <path
              d="M124.357 79.8279L64.62 95.2443C64.3385 95.3169 64.0455 95.3334 63.7577 95.2927C63.4698 95.252 63.1929 95.155 62.9425 95.0072C62.6921 94.8594 62.4733 94.6636 62.2986 94.4312C62.1238 94.1988 61.9965 93.9342 61.9239 93.6525C61.8513 93.3708 61.8349 93.0776 61.8755 92.7895C61.9162 92.5015 62.0131 92.2243 62.1608 91.9738C62.3085 91.7232 62.5041 91.5043 62.7364 91.3294C62.9686 91.1545 63.233 91.0271 63.5145 90.9544L123.252 75.5381C123.82 75.3914 124.424 75.4767 124.929 75.7752C125.435 76.0737 125.801 76.561 125.948 77.1299C126.095 77.6987 126.009 78.3026 125.711 78.8086C125.413 79.3146 124.926 79.6812 124.357 79.8279Z"
              fill="#F2F2F2"
            />
            <path
              d="M122.011 107.313L71.1146 120.447C70.5463 120.593 69.9432 120.508 69.4379 120.209C68.9327 119.911 68.5665 119.424 68.42 118.855C68.2735 118.286 68.3585 117.683 68.6565 117.177C68.9545 116.671 69.441 116.304 70.0091 116.157L120.905 103.023C121.474 102.876 122.077 102.961 122.583 103.26C123.088 103.558 123.455 104.046 123.601 104.614C123.748 105.183 123.663 105.787 123.364 106.293C123.066 106.799 122.579 107.166 122.011 107.313Z"
              fill="#F2F2F2"
            />
            <path
              d="M132.718 112.27L72.98 127.686C72.6985 127.759 72.4053 127.776 72.1173 127.735C71.8293 127.695 71.5521 127.598 71.3015 127.45C71.0509 127.302 70.8319 127.107 70.657 126.874C70.4821 126.642 70.3547 126.377 70.282 126.095C70.2094 125.813 70.193 125.52 70.2337 125.232C70.2745 124.943 70.3716 124.666 70.5195 124.415C70.6674 124.165 70.8632 123.946 71.0957 123.771C71.3282 123.596 71.5929 123.469 71.8746 123.396L131.612 107.98C132.181 107.833 132.784 107.919 133.29 108.217C133.795 108.516 134.162 109.003 134.308 109.572C134.455 110.141 134.37 110.745 134.071 111.251C133.773 111.757 133.286 112.123 132.718 112.27V112.27Z"
              fill="#F2F2F2"
            />
            <path
              d="M45.7057 69.0307L27.6941 73.6789C27.4215 73.7489 27.1324 73.7079 26.89 73.5648C26.6476 73.4217 26.4719 73.1883 26.4013 72.9157L22.2668 56.8711C22.1968 56.5983 22.2378 56.3089 22.3808 56.0664C22.5238 55.8239 22.7571 55.648 23.0295 55.5774L41.0411 50.9291C41.3137 50.8591 41.6029 50.9002 41.8452 51.0433C42.0876 51.1864 42.2633 51.4198 42.3339 51.6924L46.4684 67.737C46.5384 68.0097 46.4974 68.2991 46.3544 68.5417C46.2114 68.7842 45.9781 68.9601 45.7057 69.0307V69.0307Z"
              fill="#E6E6E6"
            />
            <path
              d="M54.0658 101.473L36.0542 106.121C35.7816 106.191 35.4925 106.15 35.2501 106.007C35.0077 105.864 34.832 105.63 34.7614 105.358L30.6269 89.3132C30.5569 89.0405 30.5979 88.7511 30.7409 88.5085C30.8839 88.266 31.1172 88.0901 31.3896 88.0195L49.4012 83.3713C49.6738 83.3013 49.9629 83.3423 50.2053 83.4854C50.4477 83.6285 50.6234 83.862 50.694 84.1346L54.8285 100.179C54.8985 100.452 54.8575 100.741 54.7145 100.984C54.5715 101.226 54.3382 101.402 54.0658 101.473V101.473Z"
              fill="#E6E6E6"
            />
            <path
              d="M62.4258 133.915L44.4142 138.563C44.1416 138.633 43.8525 138.592 43.6101 138.449C43.3677 138.306 43.192 138.072 43.1214 137.8L38.9869 121.755C38.9169 121.482 38.9579 121.193 39.1009 120.951C39.2439 120.708 39.4772 120.532 39.7496 120.462L57.7612 115.813C58.0338 115.743 58.3229 115.784 58.5653 115.927C58.8077 116.071 58.9834 116.304 59.054 116.577L63.1885 132.621C63.2585 132.894 63.2175 133.183 63.0745 133.426C62.9315 133.668 62.6982 133.844 62.4258 133.915V133.915Z"
              fill="#E6E6E6"
            />
            <path
              d="M180.816 30.4017H76.8774C73.3533 30.4057 69.9747 31.8084 67.4829 34.3021C64.991 36.7958 63.5893 40.1769 63.5853 43.7035V165.838C63.5893 169.365 64.991 172.746 67.4829 175.24C69.9747 177.733 73.3533 179.136 76.8774 179.14H180.816C184.34 179.136 187.719 177.733 190.211 175.24C192.703 172.746 194.104 169.365 194.108 165.838V43.7035C194.104 40.1769 192.703 36.7958 190.211 34.3021C187.719 31.8084 184.34 30.4057 180.816 30.4017V30.4017Z"
              fill="#E6E6E6"
            />
            <path
              d="M180.816 34.2311H76.8774C74.3678 34.2339 71.9618 35.2328 70.1873 37.0086C68.4127 38.7845 67.4146 41.1922 67.4117 43.7036V165.838C67.4146 168.35 68.4127 170.757 70.1873 172.533C71.9618 174.309 74.3678 175.308 76.8774 175.311H180.816C183.326 175.308 185.732 174.309 187.506 172.533C189.281 170.757 190.279 168.35 190.282 165.838V43.7036C190.279 41.1922 189.281 38.7845 187.506 37.0087C185.732 35.2328 183.326 34.2339 180.816 34.2311V34.2311Z"
              fill="white"
            />
            <path
              d="M191.736 194C205.137 194 216 183.129 216 169.718C216 156.308 205.137 145.436 191.736 145.436C178.335 145.436 167.472 156.308 167.472 169.718C167.472 183.129 178.335 194 191.736 194Z"
              fill="#6C63FF"
            />
            <path
              d="M203.34 166.551H194.901V158.105C194.901 157.265 194.567 156.459 193.974 155.866C193.38 155.272 192.575 154.938 191.736 154.938C190.896 154.938 190.091 155.272 189.498 155.866C188.904 156.459 188.571 157.265 188.571 158.105V166.551H180.131C179.292 166.551 178.487 166.885 177.893 167.479C177.3 168.073 176.966 168.878 176.966 169.718C176.966 170.558 177.3 171.364 177.893 171.958C178.487 172.552 179.292 172.885 180.131 172.885H188.571V181.331C188.571 182.171 188.904 182.977 189.498 183.571C190.091 184.165 190.896 184.498 191.736 184.498C192.575 184.498 193.38 184.165 193.974 183.571C194.567 182.977 194.901 182.171 194.901 181.331V172.885H203.34C204.18 172.885 204.985 172.552 205.578 171.958C206.172 171.364 206.505 170.558 206.505 169.718C206.505 168.878 206.172 168.073 205.578 167.479C204.985 166.885 204.18 166.551 203.34 166.551V166.551Z"
              fill="white"
            />
            <path
              d="M165.173 101.344H112.612C112.321 101.344 112.033 101.287 111.764 101.176C111.496 101.065 111.251 100.902 111.045 100.696C110.84 100.49 110.676 100.246 110.565 99.9769C110.454 99.708 110.396 99.4198 110.396 99.1287C110.396 98.8376 110.454 98.5493 110.565 98.2804C110.676 98.0115 110.84 97.7672 111.045 97.5615C111.251 97.3558 111.496 97.1927 111.764 97.0815C112.033 96.9703 112.321 96.9133 112.612 96.9136H165.173C165.76 96.9142 166.322 97.1479 166.737 97.5632C167.152 97.9786 167.384 98.5416 167.384 99.1287C167.384 99.7157 167.152 100.279 166.737 100.694C166.322 101.109 165.76 101.343 165.173 101.344V101.344Z"
              fill="#E6E6E6"
            />
            <path
              d="M174.304 108.82H112.612C112.321 108.82 112.033 108.763 111.764 108.652C111.496 108.541 111.251 108.378 111.045 108.172C110.84 107.966 110.676 107.722 110.565 107.453C110.454 107.184 110.396 106.896 110.396 106.605C110.396 106.314 110.454 106.025 110.565 105.756C110.676 105.487 110.84 105.243 111.045 105.037C111.251 104.832 111.496 104.669 111.764 104.557C112.033 104.446 112.321 104.389 112.612 104.39H174.304C174.891 104.39 175.454 104.623 175.869 105.038C176.284 105.454 176.518 106.017 176.518 106.605C176.518 107.192 176.284 107.756 175.869 108.171C175.454 108.586 174.891 108.82 174.304 108.82Z"
              fill="#E6E6E6"
            />
            <path
              d="M165.173 134.847H112.612C112.321 134.848 112.033 134.79 111.764 134.679C111.496 134.568 111.251 134.405 111.045 134.199C110.84 133.994 110.676 133.749 110.565 133.48C110.454 133.211 110.396 132.923 110.396 132.632C110.396 132.341 110.454 132.053 110.565 131.784C110.676 131.515 110.84 131.271 111.045 131.065C111.251 130.859 111.496 130.696 111.764 130.585C112.033 130.474 112.321 130.417 112.612 130.417H165.173C165.76 130.417 166.323 130.65 166.739 131.066C167.154 131.481 167.387 132.045 167.387 132.632C167.387 133.22 167.154 133.783 166.739 134.198C166.323 134.614 165.76 134.847 165.173 134.847V134.847Z"
              fill="#E6E6E6"
            />
            <path
              d="M174.304 142.323H112.612C112.321 142.324 112.033 142.267 111.764 142.155C111.496 142.044 111.251 141.881 111.045 141.675C110.84 141.47 110.676 141.225 110.565 140.956C110.454 140.688 110.396 140.399 110.396 140.108C110.396 139.817 110.454 139.529 110.565 139.26C110.676 138.991 110.84 138.747 111.045 138.541C111.251 138.335 111.496 138.172 111.764 138.061C112.033 137.95 112.321 137.893 112.612 137.893H174.304C174.595 137.893 174.883 137.95 175.152 138.061C175.421 138.172 175.665 138.335 175.871 138.541C176.077 138.747 176.24 138.991 176.351 139.26C176.463 139.529 176.52 139.817 176.52 140.108C176.52 140.399 176.463 140.688 176.351 140.956C176.24 141.225 176.077 141.47 175.871 141.675C175.665 141.881 175.421 142.044 175.152 142.155C174.883 142.267 174.595 142.324 174.304 142.323Z"
              fill="#E6E6E6"
            />
            <path
              d="M100.838 112.214H82.2374C81.956 112.213 81.6862 112.101 81.4872 111.902C81.2883 111.703 81.1763 111.433 81.176 111.151V94.5819C81.1763 94.3003 81.2883 94.0303 81.4872 93.8312C81.6862 93.6321 81.956 93.5201 82.2374 93.5198H100.838C101.12 93.5201 101.389 93.6321 101.588 93.8312C101.787 94.0303 101.899 94.3003 101.9 94.5819V111.151C101.899 111.433 101.787 111.703 101.588 111.902C101.389 112.101 101.12 112.213 100.838 112.214V112.214Z"
              fill="#E6E6E6"
            />
            <path
              d="M100.838 145.717H82.2374C81.956 145.717 81.6862 145.605 81.4872 145.406C81.2883 145.206 81.1763 144.936 81.176 144.655V128.085C81.1763 127.804 81.2883 127.534 81.4872 127.335C81.6862 127.136 81.956 127.024 82.2374 127.023H100.838C101.12 127.024 101.389 127.136 101.588 127.335C101.787 127.534 101.899 127.804 101.9 128.085V144.655C101.899 144.936 101.787 145.206 101.588 145.406C101.389 145.605 101.12 145.717 100.838 145.717V145.717Z"
              fill="#E6E6E6"
            />
            <path
              d="M165.232 64.0478H126.481C125.894 64.0478 125.331 63.8144 124.915 63.399C124.5 62.9836 124.267 62.4201 124.267 61.8327C124.267 61.2452 124.5 60.6818 124.915 60.2663C125.331 59.8509 125.894 59.6176 126.481 59.6176H165.232C165.819 59.6176 166.382 59.8509 166.797 60.2663C167.212 60.6818 167.445 61.2452 167.445 61.8327C167.445 62.4201 167.212 62.9836 166.797 63.399C166.382 63.8144 165.819 64.0478 165.232 64.0478Z"
              fill="#CCCCCC"
            />
            <path
              d="M174.362 71.5238H126.481C126.19 71.5238 125.902 71.4665 125.634 71.3552C125.365 71.2439 125.121 71.0807 124.915 70.875C124.71 70.6694 124.547 70.4252 124.436 70.1564C124.324 69.8877 124.267 69.5996 124.267 69.3087C124.267 69.0178 124.324 68.7298 124.436 68.461C124.547 68.1923 124.71 67.9481 124.915 67.7424C125.121 67.5367 125.365 67.3736 125.634 67.2622C125.902 67.1509 126.19 67.0936 126.481 67.0936H174.362C174.95 67.0936 175.513 67.327 175.928 67.7424C176.343 68.1578 176.576 68.7212 176.576 69.3087C176.576 69.8962 176.343 70.4596 175.928 70.875C175.513 71.2905 174.95 71.5238 174.362 71.5238V71.5238Z"
              fill="#CCCCCC"
            />
            <path
              d="M117.904 80.5838H82.179C81.8976 80.5835 81.6279 80.4715 81.4289 80.2723C81.2299 80.0732 81.118 79.8032 81.1177 79.5216V51.6198C81.118 51.3382 81.2299 51.0682 81.4289 50.869C81.6279 50.6699 81.8976 50.5579 82.179 50.5576H117.904C118.186 50.5579 118.455 50.6699 118.654 50.869C118.853 51.0682 118.965 51.3382 118.966 51.6198V79.5216C118.965 79.8032 118.853 80.0732 118.654 80.2723C118.455 80.4715 118.186 80.5835 117.904 80.5838V80.5838Z"
              fill="#6C63FF"
            />
          </svg>
        </label>
        <input
          type="file"
          name="uploadfile"
          id="uploadfile"
          className="uploadfile"
          accept=".txt"
          onChange={handleFileInput}
        />
        {chatDetails ? (
          <select
            name="select_sender_name"
            id=""
            className="selectSender"
            onChange={(e) => {
              setuser(e.target.value);
            }}
            defaultValue={user}
          >
            <option value="--select an option--">--select an option--</option>
            {chatDetails.sender.map((item) => (
              <option value={item}>{item}</option>
            ))}
          </select>
        ) : (
          ""
        )}
        <div className="infoText">
          Read your exported file of whatsapp chat with a person or group chat
          and you can check analytics of the selected chat in the analytics tab
          too...
        </div>
      </>
    </div>
  );
};
export default UploadFile;
